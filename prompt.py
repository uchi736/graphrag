"""
プロンプト管理モジュール
全LLMプロンプトを一元管理
"""

# =============================================================================
# エンティティ抽出プロンプト
# =============================================================================
ENTITY_EXTRACTION_PROMPT = """あなたは質問文からエンティティを抽出する専門家です。
以下の質問文から、検索に有用なエンティティを抽出してください。

【抽出対象】
- 固有名詞（人名、組織名、製品名、地名など）
- 専門用語・技術用語
- 重要な概念・キーワード

【ルール】
- エンティティのみをカンマ区切りで出力（説明不要）
- 略語がある場合は略語と正式名称の両方を出力
- 該当するエンティティがない場合は「なし」と出力

【例】
質問: Azure Cognitive Searchのセマンティック検索とキーワード検索の違いは？
エンティティ: Azure Cognitive Search,セマンティック検索,キーワード検索

質問: {question}

エンティティ:"""


# =============================================================================
# 関係性リランキングプロンプト（Top-K選択方式）
# =============================================================================
RELATION_RANKING_PROMPT = """あなたはナレッジグラフの「関係性（エッジ）」選定器です。
質問に答えるために有用な関係性IDを、候補リストから最大{top_k}件選んでください。

【質問】
{question}

【グラフ関係性（候補）】
{relations_text}

【評価基準（重要順）】
1) 必須性: その関係がないと答えに到達しにくい（直接の根拠 / 推論の橋渡し）
2) 具体性: 質問の制約（対象・条件・期間・数値・比較軸など）に合う
3) 接続性: マルチホップ推論に必要な「つなぎ」の関係（中間ノードへ到達できる）
4) ノイズ回避: 汎用すぎる/曖昧/質問と無関係な関係は落とす

【厳守】
- 必ず「候補に存在するID」だけを選ぶ（リスト外の捏造は禁止）
- 同じIDを重複して出力しない
- 出力は **IDのみ** をカンマ区切り（例: 1,5,3）で、関連性が高い順
- 解説・ラベル・空白・改行・句読点など、**ID以外の文字を一切出さない**
- 適切なものがなければ空でよい（何も出力しない）

【出力】
"""


# =============================================================================
# QA回答プロンプト（Graph-RAG用）
# =============================================================================
QA_PROMPT = """あなたはGraph-RAG（ナレッジグラフ + 文書）で質問応答する専門家です。
与えられた【参考情報】の範囲"だけ"で、検証可能な回答を作成してください。

【質問】
{question}

【参考情報】（必ずこの中だけを使う）
{context}

【参考情報の読み方】
- <GRAPH_CONTEXT> : トリプル（A -[関係]-> B）。関係の"骨格"や推論の橋渡しに使う
- <DOCUMENT_CONTEXT> : 原文チャンク。事実・定義・数値・条件・例外の根拠は基本こちら
- タグが無い場合、すべて <DOCUMENT_CONTEXT> とみなす

【厳守（Grounding）】
- 外部知識・一般常識・推測で補完しない（参考情報に無いことは「不明/不足」と言う）
- 断定する文は、必ず根拠（文書 or トリプル）を添える
- 数値・日付・固有名詞・手順/条件は、文書根拠を優先して一致させる
- 参考情報が矛盾する場合は、矛盾している旨とそれぞれの出典を併記し、どちらとも断定しない

【出典の書き方】
- 文書: 文末に [出典: ファイル名]（可能なら章/節/ページ/チャンクIDも含める）
- グラフ: 文末に [出典: KG]（可能ならトリプルID/由来ファイルも含める）

【出力形式】
1) 【回答】
   - 日本語で簡潔に。箇条書き可。質問に直接答える
2) 【根拠】
   - 回答を支える根拠を列挙（文書引用/要約 + 出典、必要ならトリプルも）
   - トリプルは (A -[REL]-> B) の形で記載
3) 【不足情報】（必要な場合のみ）
   - 回答に必須だが参考情報に無い項目を短く列挙

【回答】
"""


# =============================================================================
# ナレッジグラフ抽出プロンプト（LLMGraphTransformer用）
# =============================================================================
KG_SYSTEM_PROMPT = """あなたはテキストからナレッジグラフを構築する専門家です。
ドメイン固有の専門用語（Term）をノードとして抽出し、関係性を特定してください。

【ノード抽出基準】
- 抽出する: 技術用語、概念、固有名詞、プロセス名、規格名
- 抽出しない: 一般的な名詞（「こと」「もの」「方法」）、代名詞、動詞

【関係性タイプ】以下から選択:
- IS_A: AはBの一種（分類・継承）
- BELONGS_TO_CATEGORY: AはBカテゴリに属する
- PART_OF: AはBの一部
- HAS_STEP: AにはBというステップがある
- HAS_ATTRIBUTE: AにはBという属性がある
- RELATED_TO: AとBは関連がある（他に適切な関係がない場合のみ）
- AFFECTS: AはBに影響する
- CAUSES: AはBの原因になる
- DEPENDS_ON: AはBに依存する
- APPLIES_TO: AはBに適用される
- OWNED_BY: AはBが所有する
- SAME_AS: AとBは同義"""

KG_USER_PROMPT = """以下のテキストから専門用語（ノード）と関係性（エッジ）を抽出してください。
RELATED_TOは他に適切な関係がない場合の最終手段として使用してください。

テキスト:
{input}
"""


# =============================================================================
# 自然言語→Cypherクエリ変換プロンプト
# =============================================================================
NL_TO_CYPHER_PROMPT = """あなたはNeo4jのCypherクエリエキスパートです。
以下の自然言語をCypherクエリに変換してください。

【グラフスキーマ情報】
- ノード: プロパティは `id` (エンティティ名を格納)
- リレーションシップ: 動的（MENTIONS以外のすべての関係タイプ）
- 除外条件: チャンクノード（id =~ '[0-9a-f]{{32}}'）は除外すること
- MENTIONS関係は除外すること

【クエリ作成ルール】
1. RETURN句で必ず以下を返すこと:
   - ノード間の関係の場合: n.id AS source, type(r) AS relation, m.id AS target
   - ノードのみの場合: n.id AS node_id, labels(n) AS labels
2. チャンクノードを除外: WHERE NOT n.id =~ '[0-9a-f]{{32}}'
3. MENTIONS関係を除外: WHERE type(r) <> 'MENTIONS'
4. LIMIT句を必ず付与（デフォルト50）

【例】
自然言語: 機械学習に関連するノードを探して
Cypher: MATCH (n)-[r]->(m) WHERE n.id CONTAINS '機械学習' AND NOT n.id =~ '[0-9a-f]{{32}}' AND NOT m.id =~ '[0-9a-f]{{32}}' AND type(r) <> 'MENTIONS' RETURN n.id AS source, type(r) AS relation, m.id AS target LIMIT 50

自然言語: AとBの関係を教えて
Cypher: MATCH (n)-[r]->(m) WHERE (n.id CONTAINS 'A' AND m.id CONTAINS 'B') AND NOT n.id =~ '[0-9a-f]{{32}}' AND NOT m.id =~ '[0-9a-f]{{32}}' AND type(r) <> 'MENTIONS' RETURN n.id AS source, type(r) AS relation, m.id AS target LIMIT 50

自然言語クエリ: {query}

Cypherクエリ（クエリのみ出力、説明不要）:"""


# =============================================================================
# 検索結果リランキングプロンプト
# =============================================================================
RERANK_PROMPT = """あなたは検索結果の関連度を評価するリランキング専門家です。
質問に対する各ドキュメントの関連度を評価し、関連度が高い順に番号を出力してください。

【質問】
{question}

【ドキュメント】
{documents}

【評価基準（重要順）】
1) 質問への直接的な回答や根拠が含まれているか
2) 質問の意図・文脈に沿った情報か（単なるキーワード一致ではなく意味的に関連）
3) 具体的で検証可能な情報（数値、手順、定義、条件など）があるか
4) 情報の完全性（部分的な言及より包括的な説明を優先）

【厳守】
- 関連度が高い順に番号をカンマ区切りで出力
- 番号以外の文字は一切出力しない
- 全てのドキュメント番号を含めること（漏れなく順位付け）
- 例: 3,1,5,2,4

【出力】"""
